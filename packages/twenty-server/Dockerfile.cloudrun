# Dockerfile optimizado para Cloud Run - Solo Backend
FROM node:24-alpine AS common-deps

WORKDIR /app

# Copy dependency files
COPY ./package.json ./yarn.lock ./.yarnrc.yml ./tsconfig.base.json ./nx.json /app/
COPY ./.yarn/releases /app/.yarn/releases
COPY ./.yarn/patches /app/.yarn/patches
COPY ./.prettierrc /app/

# Copy package.json files for workspace dependencies
COPY ./packages/twenty-emails/package.json /app/packages/twenty-emails/
COPY ./packages/twenty-server/package.json /app/packages/twenty-server/
COPY ./packages/twenty-server/patches /app/packages/twenty-server/patches
COPY ./packages/twenty-ui/package.json /app/packages/twenty-ui/
COPY ./packages/twenty-shared/package.json /app/packages/twenty-shared/

# Install all dependencies (including devDependencies for build)
RUN yarn install && yarn cache clean && npx nx reset

# Build stage
FROM common-deps AS build

COPY ./packages/twenty-emails /app/packages/twenty-emails
COPY ./packages/twenty-shared /app/packages/twenty-shared
COPY ./packages/twenty-server /app/packages/twenty-server

# Build the backend
RUN npx nx run twenty-server:build

# Install only production dependencies
RUN yarn workspaces focus --production twenty-emails twenty-shared twenty-server

# Production stage
FROM node:24-alpine

RUN apk add --no-cache curl postgresql-client

WORKDIR /app/packages/twenty-server

# Copy built application and dependencies
COPY --from=build /app /app
COPY --from=build /app/packages/twenty-server /app/packages/twenty-server

# Create storage directory
RUN mkdir -p /app/.local-storage && chown -R 1000:1000 /app

USER 1000

# Cloud Run sets PORT automatically, default to 8080
# PORT will be available at runtime, we'll pass it as NODE_PORT
EXPOSE 8080

# Cloud Run sets PORT at runtime, we need to pass it as NODE_PORT
# Using exec to replace shell process with Node.js (better signal handling)
# Using 2>&1 to redirect stderr to stdout so errors appear in logs
CMD ["sh", "-c", "NODE_PORT=${PORT:-8080} exec node dist/src/main 2>&1"]

